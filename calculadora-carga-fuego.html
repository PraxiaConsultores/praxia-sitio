<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Calculador de Carga de Fuego — V1 Final</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Estilos generales (intento replicar el look del informe: limpio, azul/gris) */
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --accent:#1b63a8;
      --muted:#6b7280;
      --border:#e6eef8;
      --report-bg:#fbfdff;
    }
    body{font-family:Inter, Arial, sans-serif; background:var(--bg); margin:14px; color:#111}
    h1{font-size:20px;color:var(--accent);margin:0 0 6px 0}
    .container{display:grid; grid-template-columns:360px 1fr; gap:14px}
    .card{background:var(--card); padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.04)}
    label{display:block; font-size:13px; margin-top:8px}
    input[type="text"], input[type="number"], select, textarea{width:100%; padding:8px; margin-top:6px; box-sizing:border-box; font-size:13px; border:1px solid #dfeefb; border-radius:6px}
    button{padding:8px 10px; margin-top:8px; cursor:pointer; border-radius:6px; border:none; background:var(--accent); color:#fff}
    .muted{color:var(--muted); font-size:13px}
    .small{font-size:12px}
    .steps{display:flex; gap:8px; margin-bottom:8px}
    .sector{border:1px dashed #e3edf9; padding:8px; border-radius:6px; margin-top:8px; background:#fff}
    .materials{margin-top:8px}
    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{border:1px solid #e9f2fb; padding:6px; font-size:13px; text-align:left}
    .right{text-align:right}
    .report{background:var(--report-bg); padding:14px; border-radius:8px; min-height:400px; overflow:auto; border:1px solid #e6f0fb}
    .header-report{background:var(--accent); color:#fff; padding:8px; border-radius:6px; margin-bottom:10px}
    .btn-ghost{background:#fff;color:var(--accent); border:1px solid var(--accent)}
    .rules{font-size:13px; border:1px solid #e6eef8; padding:8px; border-radius:6px; background:#fcfdff}
    .table-clickable td{cursor:pointer}
    .confirm-box{background:#fff7e6; border-left:4px solid #ffb020; padding:8px; margin-top:8px; border-radius:6px}
    .flex{display:flex; gap:8px; align-items:center}
    .flex-between{display:flex; justify-content:space-between; align-items:center}
    .logo-sim{width:48px;height:48px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700}
  </style>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <div class="flex-between" style="margin-bottom:12px">
    <div style="display:flex; gap:12px; align-items:center">
      <div class="logo-sim">CF</div>
      <div>
        <h1>Calculador de Carga de Fuego — V1 Final</h1>
        <div class="muted small">Generador de informe compatible con Decreto 351/79 — Basado en tu plantilla</div>
      </div>
    </div>
    <div class="muted small">Versión 1 — Prototipo</div>
  </div>

  <div class="container">
    <!-- PANEL IZQUIERDO: flujo y formularios -->
    <div class="card">
      <div class="muted small">1) DATOS GENERALES</div>
      <label>Nombre de la Empresa
        <input id="company_name" type="text" placeholder="Ej: Planta Bilbao" />
      </label>
      <label>Rubro
        <input id="company_rubro" type="text" placeholder="Ej: Textil" />
      </label>
      <div style="display:flex; gap:8px">
        <div style="flex:1">
          <label>Fecha
            <input id="company_fecha" type="text" disabled />
          </label>
        </div>
        <div style="width:140px">
          <label>Superficie total (m²)
            <input id="company_area" type="number" />
          </label>
        </div>
      </div>
      <label>Tipo de ventilación
        <select id="company_vent">
          <option>Natural</option>
          <option>Mecánica</option>
        </select>
      </label>
      <label>Realizado por
        <input id="company_realizado" type="text" placeholder="Nombre del usuario" />
      </label>

      <div class="flex" style="margin-top:8px">
        <button id="save_company">Guardar datos</button>
        <button id="reset_all" class="btn-ghost">Reset</button>
      </div>

      <hr/>

      <div class="muted small">2) DETERMINAR NIVEL DE RIESGO (TABLA 2.1)</div>
      <div class="rules" id="tabla21_container">
        <!-- TABLA 2.1 será renderizada aquí -->
      </div>
      <div style="margin-top:8px" id="risk_confirm_area"></div>

      <hr/>

      <div class="muted small">3) SECTORES (agregá sectores y materiales)</div>
      <div class="flex" style="margin-top:6px">
        <button id="new_sector">+ Nuevo sector</button>
        <button id="clear_sectors" class="btn-ghost">Limpiar</button>
      </div>
      <div id="sectors_list"></div>

      <hr/>

      <div class="muted small">4) TABLAS NORMATIVAS (editable)</div>
      <div class="rules" id="rules_area">
        <!-- CUADRO 2.2.2 y TABLA 1/2 editables -->
      </div>

      <div style="display:flex; gap:8px; margin-top:10px">
        <button id="generate_report">Generar Informe</button>
        <button id="download_pdf" class="btn-ghost" disabled>Descargar PDF</button>
      </div>

      <div class="muted small" style="margin-top:8px">Nota: los valores normativos pueden editarse en la sección "TABLAS NORMATIVAS" si deseás asegurarte de que coincidan exactamente con la normativa que usás.</div>
    </div>

    <!-- PANEL DERECHO: vista informe -->
    <div class="card">
      <div class="header-report">
        <strong>Vista Previa del Informe</strong>
      </div>

      <div id="report_view" class="report">
        <!-- Contenido del informe (text + formato) -->
        <div id="report_html_area" style="white-space:normal; font-size:13px; line-height:1.35; color:#111">
          <p class="muted">No hay informe generado aún. Guardá los datos de la empresa, seleccioná el riesgo y agregá al menos un sector con materiales. Luego presioná "Generar Informe".</p>
        </div>
      </div>
    </div>
  </div>

<script>
/* ============================
   Datos iniciales y utilidades
   ============================ */
document.getElementById('company_fecha').value = new Date().toLocaleDateString();

// CARGA de PCI desde tu tabla (Mcal/kg) — tomé los ítems más usados; podés editar/añadir desde UI
const PCI_LIBRARY = [
  {key:'madera', label:'Maderas', pci:4.4},
  {key:'papel', label:'Papel', pci:4},
  {key:'textil', label:'Vestimentas/Textil', pci:4.5},
  {key:'plastico_pe', label:'Polietileno', pci:11},
  {key:'plástico_general', label:'Materiales sintéticos (gen.)', pci:4},
  {key:'pvc', label:'P.V.C.', pci:5},
  {key:'aluminio', label:'Aluminio (incombustible - tomar 0)', pci:0.1},
  {key:'aceite', label:'Aceites', pci:9.5},
  {key:'gasoil', label:'Gasoil/Petróleo', pci:10},
  {key:'carton', label:'Cartón', pci:4},
  {key:'caucho', label:'Caucho', pci:10},
  {key:'panel_madera', label:'Paneles de madera', pci:4.4}
];

// TABLA 2.1 estructura (interactiva) — se renderiza como matriz donde el usuario selecciona R1..R7
// Para simplificar la UI, dejo las actividades como filas y las columnas 1..7 como botones
const TABLA_21 = [
  {actividad:'Residencial / Administrativo', c:[null,null,'R3','R4',null,null,null]},
  {actividad:'Comercial / Industrial / Depósito', c:['R1','R2','R3','R4','R5','R6','R7']},
  {actividad:'Espectáculos / Cultura', c:[null,null,'R3','R4',null,null,null]}
];

// CUADRO 2.2.2 (Carga de fuego en kg/m2 → Resistencia Fxx) — default values (editables)
let CUADRO_22 = {
  // ranges defined by minInclusive, maxInclusive (kg/m2)
  ranges: [
    {min:0, max:15, f:{'1': '--','2':'NP','3':'F60','4':'F60','5':'F60','6':'F60','7':'F60'}},
    {min:16, max:30, f:{'1':'--','2':'NP','3':'F60','4':'F90','5':'F90','6':'F90','7':'F90'}},
    {min:31, max:60, f:{'1':'--','2':'NP','3':'F90','4':'F120','5':'F120','6':'F120','7':'F120'}},
    {min:61, max:100, f:{'1':'--','2':'NP','3':'F120','4':'F180','5':'F180','6':'F180','7':'F180'}},
    {min:101, max:Infinity, f:{'1':'A determinar','2':'A determinar','3':'A determinar','4':'A determinar','5':'A determinar','6':'A determinar','7':'A determinar'}}
  ]
};

// TABLA 1 (Potencial extintor para fuegos Clase A) — mapping CF range & risk -> A-rating
let TABLA_1 = [
  {min:0, max:15, pot:{'1': null, '2': null, '3':'1A','4':'1A','5':'1A'}},
  {min:16, max:30, pot:{'1': null, '2': null, '3':'2A','4':'1A','5':'1A'}},
  {min:31, max:60, pot:{'1': null, '2': null, '3':'3A','4':'2A','5':'1A'}},
  {min:61, max:100, pot:{'1': null, '2': null, '3':'6A','4':'4A','5':'3A'}},
  {min:101, max:Infinity, pot:{'1':'A determinar','2':'A determinar','3':'A determinar','4':'A determinar','5':'A determinar'}}
];

// TABLA 2 (Potencial extintor para fuegos Clase B) — mapping CF range & risk -> B-rating
let TABLA_2 = [
  {min:0, max:15, pot:{'1':null,'2':'6B','3':'4B','4':null,'5':'1B'}},
  {min:16, max:30, pot:{'1':null,'2':'8B','3':'6B','4':null,'5':'1B'}},
  {min:31, max:60, pot:{'1':null,'2':'10B','3':'8B','4':null,'5':null}},
  {min:61, max:100, pot:{'1':null,'2':'20B','3':'10B','4':null,'5':null}},
  {min:101, max:Infinity, pot:{'1':'A determinar','2':'A determinar','3':'A determinar','4':'A determinar','5':'A determinar'}}
];

// Almacenamiento local temporal (sectores)
let COMPANY = null;
let SELECTED_RISK = null;
let SECTORS = []; // each: {name, area_m2, materials: [{key,label,kg,pci}], calc: {E_total_mcal, equiv_wood_kg, cf_kg_m2}, resistencia, potencialA, potencialB, recomendacion}

// UTIL helpers
function el(tag, attrs={}, inner=''){ const d=document.createElement(tag); for(const k in attrs) if(k.startsWith('on')) d.addEventListener(k.slice(2), attrs[k]); else d[k]=attrs[k]; if(inner) d.innerHTML = inner; return d; }
function nnum(x){ return (isFinite(x) ? Number(x) : 0); }
function round(v, d=3){ const p=Math.pow(10,d); return Math.round((v+Number.EPSILON)*p)/p; }

// ========== RENDER TABLA 2.1 (interactiva) ==========
function renderTabla21(){
  const cont = document.getElementById('tabla21_container');
  cont.innerHTML = '';
  const tbl = el('table');
  tbl.className = 'table-clickable';
  const header = el('tr');
  header.innerHTML = '<th>Actividad predominante</th>' + Array.from({length:7},(_,i)=>`<th>R${i+1}</th>`).join('');
  tbl.appendChild(header);
  TABLA_21.forEach((row, rIdx)=>{
    const tr = el('tr');
    tr.innerHTML = `<td>${row.actividad}</td>`;
    row.c.forEach((cell, cIdx)=>{
      const td = el('td');
      if(cell){
        td.innerHTML = `<button class="btn-ghost" data-risk="${cell}">${cell}</button>`;
      } else {
        td.innerHTML = `<span class="muted small">NP</span>`;
      }
      tr.appendChild(td);
    });
    tbl.appendChild(tr);
  });
  cont.appendChild(tbl);
  // events: clicking a button sets SELECTED_RISK with confirmation
  cont.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', ()=>{
      const risk = b.dataset.risk;
      const name = prompt(`Confirmá la actividad y el nivel de riesgo seleccionado.\nEscribí una etiqueta para la actividad (ej: "Rubro principal") o deja vacío:`, '');
      if(!confirm(`¿Estás seguro que deseás seleccionar ${risk} para esta actividad?`)) return;
      SELECTED_RISK = risk;
      document.getElementById('risk_confirm_area').innerHTML = `<div class="confirm-box">Nivel de riesgo seleccionado: <strong>${risk}</strong>. (Podés cambiarlo volviendo a elegir en la tabla)</div>`;
    });
  });
}

// ========== RENDER TABLAS NORMATIVAS (editable) ==========
function renderRulesArea(){
  const cont = document.getElementById('rules_area');
  cont.innerHTML = '';
  // CUADRO 2.2.2 view
  const h = el('div',{},'<strong>CUADRO 2.2.2 — Carga kg/m² → Resistencia (Fxx)</strong>');
  cont.appendChild(h);
  // table preview (rows)
  const t = el('table');
  const hdr = el('tr'); hdr.innerHTML = '<th>Rango CF kg/m²</th><th>F (por riesgo 1..7)</th>';
  t.appendChild(hdr);
  CUADRO_22.ranges.forEach((r, idx)=>{
    const tr = el('tr');
    const label = `${r.min} - ${r.max===Infinity?'∞':r.max}`;
    const fvals = Object.keys(r.f).map(k=>`R${k}:${r.f[k]||'--'}`).join(' | ');
    tr.innerHTML = `<td>${label}</td><td>${fvals}</td>`;
    t.appendChild(tr);
  });
  cont.appendChild(t);

  // TABLA 1 preview
  cont.appendChild(el('div',{},'<strong style="margin-top:8px">TABLA 1 — Potencial extintor (Clase A)</strong>'));
  const t1 = el('table');
  t1.innerHTML = '<tr><th>Rango CF kg/m²</th><th>Potencial (Riesgos 1..5)</th></tr>';
  TABLA_1.forEach(r=> {
    const tr = el('tr');
    const lab = `${r.min} - ${r.max===Infinity?'∞':r.max}`;
    const pvals = Object.keys(r.pot).map(k=>`R${k}:${r.pot[k]||'--'}`).join(' | ');
    tr.innerHTML = `<td>${lab}</td><td>${pvals}</td>`;
    t1.appendChild(tr);
  });
  cont.appendChild(t1);

  // TABLA 2 preview
  cont.appendChild(el('div',{},'<strong style="margin-top:8px">TABLA 2 — Potencial extintor (Clase B)</strong>'));
  const t2 = el('table');
  t2.innerHTML = '<tr><th>Rango CF kg/m²</th><th>Potencial (Riesgos 1..5)</th></tr>';
  TABLA_2.forEach(r=> {
    const tr = el('tr');
    const lab = `${r.min} - ${r.max===Infinity?'∞':r.max}`;
    const pvals = Object.keys(r.pot).map(k=>`R${k}:${r.pot[k]||'--'}`).join(' | ');
    tr.innerHTML = `<td>${lab}</td><td>${pvals}</td>`;
    t2.appendChild(tr);
  });
  cont.appendChild(t2);

  // Edit button (to show JSON editable modal)
  const editBtn = el('button', {onclick: ()=> editNormsJSON()}, 'Editar valores (avanzado)');
  cont.appendChild(editBtn);
}

// modal-like edit (prompt with JSON)
function editNormsJSON(){
  const current = {CUADRO_22, TABLA_1, TABLA_2};
  const txt = JSON.stringify(current, null, 2);
  const edited = prompt('Editá las reglas normativas (JSON). Tené cuidado con la sintaxis.\nSi no estás cómodo, cancelá y avisame para que lo haga yo.', txt);
  if(!edited) return;
  try{
    const obj = JSON.parse(edited);
    if(obj.CUADRO_22) CUADRO_22 = obj.CUADRO_22;
    if(obj.TABLA_1) TABLA_1 = obj.TABLA_1;
    if(obj.TABLA_2) TABLA_2 = obj.TABLA_2;
    renderRulesArea();
    alert('Reglas actualizadas (temporal). Si querés que las deje fijas en el código avisame.');
  }catch(err){
    alert('Error al parsear JSON: '+err.message);
  }
}

// ========== SECTORES UI ==========
function renderSectorsList(){
  const box = document.getElementById('sectors_list');
  box.innerHTML = '';
  if(SECTORS.length===0){ box.innerHTML = '<div class="muted small">No hay sectores añadidos.</div>'; return; }
  SECTORS.forEach((s, idx)=>{
    const div = el('div',{className:'sector'});
    div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center">
      <strong>${s.name}</strong> <span class="muted small">S=${s.area_m2} m²</span>
    </div>`;
    // materials table
    const tbl = el('table');
    tbl.innerHTML = '<tr><th>Material</th><th>kg</th><th>PCI (Mcal/kg)</th><th>E (Mcal)</th><th></th></tr>';
    s.materials.forEach((m,mi)=> {
      const e = round(m.kg * m.pci,3);
      const tr = el('tr');
      tr.innerHTML = `<td>${m.label}</td><td class="right">${m.kg}</td><td class="right">${m.pci}</td><td class="right">${e}</td>
        <td><button data-s="${idx}" data-mi="${mi}" class="del_mat_btn">Eliminar</button></td>`;
      tbl.appendChild(tr);
    });
    div.appendChild(tbl);

    // calculations summary
    const sum = s.calc || {E_total_mcal:0, equiv_wood_kg:0, cf_kg_m2:0};
    const calcDiv = el('div',{},`<div style="margin-top:8px">
      <div>E total: <strong>${sum.E_total_mcal}</strong> Mcal</div>
      <div>Equivalente madera: <strong>${sum.equiv_wood_kg}</strong> kg</div>
      <div>Carga de fuego: <strong>${sum.cf_kg_m2}</strong> kg/m²</div>
      <div>Resistencia propuesta: <strong>${s.resistencia||'--'}</strong></div>
      <div>Potencial A: <strong>${s.potencialA||'--'}</strong> &nbsp; Potencial B: <strong>${s.potencialB||'--'}</strong></div>
      <div style="margin-top:6px">
        <button data-idx="${idx}" class="edit_sector">Editar</button>
        <button data-idx="${idx}" class="del_sector btn-ghost">Eliminar sector</button>
      </div>
    </div>`);
    div.appendChild(calcDiv);
    box.appendChild(div);
  });

  // events
  box.querySelectorAll('.del_mat_btn').forEach(b=>{
    b.addEventListener('click', e=>{
      const s = parseInt(b.dataset.s), mi = parseInt(b.dataset.mi);
      SECTORS[s].materials.splice(mi,1);
      recalcSector(SECTORS[s]);
      renderSectorsList();
    });
  });
  box.querySelectorAll('.del_sector').forEach(b=>{
    b.addEventListener('click', e=>{
      const i = parseInt(b.dataset.idx);
      if(!confirm('Eliminar sector?')) return;
      SECTORS.splice(i,1);
      renderSectorsList();
    });
  });
  box.querySelectorAll('.edit_sector').forEach(b=>{
    b.addEventListener('click', e=>{
      const i = parseInt(b.dataset.idx);
      editSectorModal(i);
    });
  });
}

// modal-like add sector (simple prompts)
function addNewSector(){
  if(!COMPANY){ alert('Guardá primero los datos de la empresa en la primer ventana.'); return; }
  const name = prompt('Nombre del sector (ej: Depósito materia prima):','Sector '+(SECTORS.length+1));
  if(!name) return;
  const area = parseFloat(prompt('Superficie del sector en m² (cubiertos):','100'));
  if(!area || area<=0){ alert('Superficie inválida'); return; }
  const sector = {name, area_m2:area, materials:[], calc:null, resistencia:null, potencialA:null, potencialB:null, recommendation:null};
  SECTORS.push(sector);
  // abrir editor de materiales
  editSectorModal(SECTORS.length-1);
}

// editor de sector en modal-like (simple window)
function editSectorModal(idx){
  const s = SECTORS[idx];
  // Build a simple HTML editor in a new window-like prompt using a small form inside a div
  const html = `
    EDITAR SECTOR: ${s.name} (S=${s.area_m2} m²)
    Agregar material (seleccioná de la lista o escribí uno nuevo).
    FORMATO de entrada: key,label,pci,kg
    Ejemplo para usar un material de librería: madera,Maderas,4.4,300
    (Se permiten múltiples líneas, cada línea un material)
  `;
  const input = prompt(`${html}\n\nMateriales actuales:\n` + s.materials.map(m=>`${m.key},${m.label},${m.pci},${m.kg}`).join('\n') + `\n\nIngresá las líneas nuevas (o reescribí todo):`, s.materials.map(m=>`${m.key},${m.label},${m.pci},${m.kg}`).join('\n'));
  if(input===null) return;
  const lines = input.split('\n').map(l=>l.trim()).filter(Boolean);
  const newMats = [];
  for(const L of lines){
    const parts = L.split(',').map(p=>p.trim());
    if(parts.length<4){ alert(`Línea inválida: ${L}`); return; }
    const key = parts[0], label = parts[1], pci = parseFloat(parts[2])||0, kg = parseFloat(parts[3])||0;
    newMats.push({key,label,pci,kg});
  }
  s.materials = newMats;
  recalcSector(s);
  renderSectorsList();
}

// recalcula E_total, equivalente y cf y determina reglas
function recalcSector(s){
  const E_total = s.materials.reduce((acc,m)=> acc + (nnum(m.kg)*nnum(m.pci)), 0); // Mcal
  const equiv_wood = (E_total / 4.4);
  const cf = s.area_m2>0 ? (equiv_wood / s.area_m2) : 0;
  s.calc = {E_total_mcal: round(E_total,3), equiv_wood_kg: round(equiv_wood,3), cf_kg_m2: round(cf,4)};
  // determinar resistencia a partir de CUADRO_22
  s.resistencia = lookupResistencia(cf);
  s.potencialA = lookupPotA(cf);
  s.potencialB = lookupPotB(cf);
  // recomendation: compute number by area and suggest higher option
  s.recommendation = computeRecommendations(s);
}

// ===== lookup functions based on tables
function lookupResistencia(cf){
  // find appropriate range
  for(const r of CUADRO_22.ranges){
    if(cf >= r.min && cf <= (r.max===Infinity?Infinity:r.max)){
      if(!SELECTED_RISK) return 'Riesgo no definido';
      const val = r.f[SELECTED_RISK] || '--';
      return val;
    }
  }
  return '--';
}
function lookupPotA(cf){
  for(const r of TABLA_1){
    if(cf >= r.min && cf <= (r.max===Infinity?Infinity:r.max)){
      if(!SELECTED_RISK) return '--';
      return r.pot[SELECTED_RISK] || '--';
    }
  }
  return '--';
}
function lookupPotB(cf){
  for(const r of TABLA_2){
    if(cf >= r.min && cf <= (r.max===Infinity?Infinity:r.max)){
      if(!SELECTED_RISK) return '--';
      return r.pot[SELECTED_RISK] || '--';
    }
  }
  return '--';
}

// Recommendation computation (counts)
function computeRecommendations(s){
  // a) by area: 1 extintor cada 200 m2
  const n_area = Math.ceil(s.area_m2 / 200);
  // b) by distance: we cannot compute exact required number w/o planta, so we show required max distance and mark as must-check
  const distance_req = {
    A:15,
    B:20
  };
  // c) by potential: choose extinguisher type (e.g., 2A 6BC) and we recommend minimal units to reach potential:
  // For prototype: assume 1 unit of the specified potential is enough; (user can choose the conservative option area-based)
  const potA = s.potencialA || null;
  const potB = s.potencialB || null;

  // Decide recommended count: default => choose max between area-based and 1
  const recommend_by = 'area'; // choose area (more demanding)
  const suggested_n = Math.max(n_area, 1);
  return {n_area, distance_req, potA, potB, suggested_n, recommend_by};
}

// ========== GENERAR INFORME HTML (mimic Word layout) ==========
function generateReportHTML(){
  if(!COMPANY) { alert('Guardá los datos de la empresa primero.'); return; }
  if(!SELECTED_RISK){ alert('Seleccioná el nivel de riesgo (TABLA 2.1).'); return; }
  if(SECTORS.length===0){ alert('Agregá al menos un sector.'); return; }

  // Recalc all sectors (to ensure up-to-date)
  SECTORS.forEach(s=> recalcSector(s));

  const doc = [];
  // Header (mimic your doc with color)
  doc.push(`<div style="background:${'#1b63a8'}; color:#fff; padding:12px; border-radius:6px; margin-bottom:8px">
    <h2 style="margin:0">CÁLCULO CARGA DE FUEGO</h2>
  </div>`);

  // Plant info
  doc.push(`<table style="width:100%; border:1px solid #e6f2fb; margin-bottom:8px"><tr><td style="padding:8px">
    <strong>NOMBRE:</strong> ${escapeHtml(COMPANY.name)} <br/>
    <strong>RUBRO:</strong> ${escapeHtml(COMPANY.rubro)} <br/>
    <strong>FECHA:</strong> ${escapeHtml(COMPANY.fecha)} <br/>
    <strong>SUPERFICIE:</strong> ${COMPANY.area} m² (cubiertos) <br/>
    <strong>TIPO VENTILACIÓN:</strong> ${COMPANY.vent} <br/>
    <strong>REALIZADO POR:</strong> ${escapeHtml(COMPANY.realizado)}
  </td></tr></table>`);

  // Introduction & Definitions (exact text you provided)
  doc.push(`<div style="margin-bottom:10px">
    <h3>Introducción</h3>
    <p>Para realizar la carga de fuego es necesario cuantificar el estado térmico potencial del sector de incendio y así en función de este parámetro establecer para cada riesgo, las condiciones de resistencia al fuego y de extinción que son necesarias cumplimentar.</p>
    <p>Para tal fin se define como “El peso de la madera” por unidad de superficie (kg/m2) capaz de desarrollar una cantidad de calor equivalente a la de los materiales contenidos en el sector.</p>
    <p>El decreto 351/79 reglamentario de la ley 19587 de Seguridad e Higiene adopta como patrón de referencia con poder calorífico inferior de 18.41 MJ/Kg.<br/><em>Nota: Esta unidad (mega joule) es la correspondiente al SIMELA (Sistema Métrico Legal Argentino)</em></p>
  </div>`);

  doc.push(`<div>
    <h3>DEFINICIONES</h3>
    <div style="font-size:13px; line-height:1.3">
      <strong>1.1 Carga de Fuego:</strong> Peso en madera por unidad de superficie (Kg/m2) capaz de desarrollar una cantidad de calor equivalente a la de los materiales contenidos en el sector de incendio. Los materiales líquidos contenidos en tuberías, barriles y depósitos se considerarán como uniformemente repartidos.<br/>
      <strong>1.2 Sector de Incendio:</strong> Local o conjunto de locales, delimitados por muros y entrepisos de resistencia al fuego acorde con el Riesgo y la Carga de Fuego que contiene, comunicado con un medio de escape. Los trabajos que se desarrollan al aire libre se consideran como sector de incendio.<br/>
      <strong>1.3 Resistencia al Fuego:</strong> Propiedad que se corresponde con el tiempo expresado en minutos durante un ensayo de incendio, después del cual el elemento de construcción ensayado pierde su capacidad resistente o funcional.<br/>
      <strong>1.4 Muro Corta Fuego:</strong> Muro construido con materiales de resistencia al fuego similares a lo exigido al sector de incendio que divide... (ver normativa).<br/>
      <strong>1.5 Medios de Escapes:</strong> ...<br/>
      <strong>1.6 Clases de Fuegos:</strong> Clase A: sólidos (madera, papel, telas); B: líquidos; C: instalaciones eléctricas; D: metales.<br/>
      <strong>1.7 Clasificación de los materiales según su combustión:</strong> Riesgo 1..7 (ver tabla 2.1).
    </div>
  </div>`);

  // Now sectors detailed
  doc.push(`<div style="margin-top:12px"><h3>Detalle por Sectores Evaluados</h3>`);
  SECTORS.forEach((s, i) => {
    const c = s.calc || {E_total_mcal:0, equiv_wood_kg:0, cf_kg_m2:0};
    doc.push(`<div style="border:1px solid #e6f2fb; padding:8px; margin-bottom:8px; border-radius:6px">
      <h4>Sector ${i+1} — ${escapeHtml(s.name)} (S=${s.area_m2} m²)</h4>
      <table><tr><th>Material</th><th>kg</th><th>PCI (Mcal/kg)</th><th>E (Mcal)</th></tr>
      ${s.materials.map(m=>`<tr><td>${escapeHtml(m.label)}</td><td class="right">${m.kg}</td><td class="right">${m.pci}</td><td class="right">${round(m.kg*m.pci,3)}</td></tr>`).join('')}
      </table>
      <div style="margin-top:8px">
        <div>Energía total del sector: <strong>${c.E_total_mcal} Mcal</strong></div>
        <div>Equivalente en kg madera: <strong>${c.equiv_wood_kg} kg</strong> (base 4.4 Mcal/kg)</div>
        <div>Carga de fuego (CF): <strong>${c.cf_kg_m2} kg/m²</strong></div>
        <div>Resistencia al fuego exigida (CUADRO 2.2.2): <strong>${s.resistencia || '--'}</strong></div>
        <div>Potencial extintor sugerido: Clase A → <strong>${s.potencialA||'--'}</strong> ; Clase B → <strong>${s.potencialB||'--'}</strong></div>
        <div>Recomendación de cantidad de extintores (según área): <strong>${s.recommendation ? s.recommendation.n_area : '--'}</strong> (1 extintor cada 200 m²)</div>
      </div>
    </div>`);
  });
  doc.push(`</div>`);

  // Totales globales
  const global = SECTORS.reduce((acc,s)=> {
    const c = s.calc || {E_total_mcal:0, equiv_wood_kg:0, cf_kg_m2:0};
    acc.E += c.E_total_mcal; acc.eq += c.equiv_wood_kg; acc.area += s.area_m2; return acc;
  }, {E:0, eq:0, area:0});
  const CF_global = global.area>0 ? round(global.eq / global.area,4) : 0;
  doc.push(`<div style="margin-top:12px; border-top:1px dashed #e6f2fb; padding-top:8px">
    <h3>Resumen Global</h3>
    <div>Energía total instalación: <strong>${round(global.E,3)} Mcal</strong></div>
    <div>Equivalente madera total: <strong>${round(global.eq,3)} kg</strong></div>
    <div>Carga de fuego global: <strong>${CF_global} kg/m²</strong></div>
    <div>Riesgo seleccionado: <strong>${SELECTED_RISK}</strong></div>
  </div>`);

  // Append normative tables reference
  doc.push(`<div style="margin-top:12px"><h3>Tablas Normativas (referencia)</h3>
    <div style="font-size:13px">CUADRO 2.2.2, TABLA 1 y TABLA 2 utilizados en los cálculos están incorporados en la herramienta y son editables desde la interfaz.</div>
  </div>`);

  // Conclusions
  doc.push(`<div style="margin-top:12px"><h3>Conclusiones</h3>
    <p class="muted">Este informe fue generado automáticamente. Recomendamos validar las reglas normativas y las mediciones en obra (volúmenes/masas declaradas). Se sugiere aplicar la opción más conservadora entre criterios de superficie, distancia y potencial extintor (por defecto se recomienda por superficie).</p>
  </div>`);

  // render
  document.getElementById('report_html_area').innerHTML = doc.join('');
  // enable PDF
  document.getElementById('download_pdf').disabled = false;
  // store last HTML
  window.__last_report_html = doc.join('');
}

// helper escape
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

// ========== PDF generation from HTML (simple text export) ==========
async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const html = window.__last_report_html || document.getElementById('report_html_area').innerText;
  // Convert HTML to text for now (simple)
  const tmp = document.createElement('div'); tmp.innerHTML = html;
  const text = tmp.innerText;
  const lines = doc.splitTextToSize(text, 520);
  doc.setFontSize(11);
  doc.text(lines, 40, 40);
  doc.setFontSize(9);
  doc.text(`Generado por: ${COMPANY ? COMPANY.name : ''} — ${new Date().toLocaleString()}`, 40, 780);
  doc.save('Informe_Carga_de_Fuego_v1.pdf');
}

// ========== compute & UI events ==========
document.getElementById('save_company').addEventListener('click', ()=>{
  const name = document.getElementById('company_name').value.trim();
  if(!name){ alert('Ingresá el nombre de la empresa'); return; }
  COMPANY = {
    name,
    rubro: document.getElementById('company_rubro').value.trim(),
    fecha: document.getElementById('company_fecha').value,
    area: parseFloat(document.getElementById('company_area').value) || 0,
    vent: document.getElementById('company_vent').value,
    realizado: document.getElementById('company_realizado').value.trim()
  };
  alert('Datos guardados. Ahora seleccioná el nivel de riesgo en TABLA 2.1.');
});

document.getElementById('reset_all').addEventListener('click', ()=>{
  if(!confirm('Resetear todo (empresa, riesgo, sectores)?')) return;
  COMPANY = null; SELECTED_RISK = null; SECTORS = [];
  document.getElementById('company_name').value=''; document.getElementById('company_rubro').value=''; document.getElementById('company_area').value=''; document.getElementById('company_realizado').value='';
  document.getElementById('risk_confirm_area').innerHTML='';
  renderSectorsList();
});

// risk table render
renderTabla21();
renderRulesArea();
renderSectorsList();

// add sector button
document.getElementById('new_sector').addEventListener('click', ()=> addNewSector());
document.getElementById('clear_sectors').addEventListener('click', ()=> { if(confirm('Limpiar todos los sectores?')) { SECTORS=[]; renderSectorsList(); }});

// generate report
document.getElementById('generate_report').addEventListener('click', ()=>{
  // ensure all sectors recalculated
  if(!COMPANY) { alert('Guardá los datos de la empresa.'); return; }
  if(!SELECTED_RISK) { alert('Seleccioná el nivel de riesgo (TABLA 2.1).'); return; }
  if(SECTORS.length===0) { alert('Agregá al menos un sector.'); return; }
  SECTORS.forEach(s=> recalcSector(s));
  generateReportHTML();
});

// download PDF
document.getElementById('download_pdf').addEventListener('click', downloadPDF);

/* ========== Inicial: si querés precargar ejemplos, descomenta ========== */
/*
SECTORS.push({name:'Edificio Administrativo', area_m2:400, materials:[
  {key:'papel', label:'Papel', pci:4, kg:80},
  {key:'madera', label:'Maderas', pci:4.4, kg:120}
]});
SECTORS.push({name:'Depósito Producto Terminado', area_m2:800, materials:[
  {key:'textil', label:'Vestimentas', pci:4.5, kg:2000}
]});
SECTORS.forEach(s=> recalcSector(s));
renderSectorsList();
*/
</script>

</body>
</html>
